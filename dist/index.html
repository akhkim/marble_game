<!DOCTYPE html><html lang="en"><head><script type="importmap">{"imports":{"3AI0W":"/Box2D.368c577c.wasm","4MuJI":"/andy.e41d47cb.png","4ZtA3":"/ff.f22e3cf2.svg","7OsmH":"/robert.37e945f8.png","8OvAP":"/Box2D.simd.75bf81fb.wasm","aspIg":"/Box2D.a070c79d.js","dgUqm":"/michael.2f67bdb4.png","dlSKC":"/leo.b69d121a.png","doYL4":"/kerry.6d8eaf17.png","g6HnH":"/Box2D.simd.7cdb49ce.js"}}</script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <title>Marble Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.2f316c01.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.3597a0fa.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.38143b41.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.c2eb0cfb.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.482241b6.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.721e3998.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.15b26ac4.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.c70b6780.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.1c38e27c.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.778fbd46.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.09fde066.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.b27ae6bd.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.c68c989a.png">
  <link rel="manifest" href="/assets/manifest.webmanifest">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.8429dbf3.png">
  <meta name="theme-color" content="#ffffff">

  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://lazygyu.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="lazygyu.github.io">
  <meta property="og:type" content="website">

  <link rel="stylesheet" href="/marble_game.72fc1a99.css">
</head>
<body>
<script type="module" src="/marble_game.34df32e0.js"></script>
<script type="text/javascript">window.dataLayer = window.dataLayer || [];
function gtag() {
    dataLayer.push(arguments);
}
gtag('js', new Date());
gtag('config', 'G-5899C1DJM0');
function getNames() {
    const value = document.querySelector('#in_names').value.trim();
    return value.split(/[,\r\n]/g).map((v)=>v.trim()).filter((v)=>!!v);
}
function parseName(nameStr) {
    const weightRegex = /(\/\d+)/;
    const countRegex = /(\*\d+)/;
    const hasWeight = weightRegex.test(nameStr);
    const hasCount = countRegex.test(nameStr);
    const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
    const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
    const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
    return {
        name,
        weight,
        count
    };
}
function getReady() {
    const names = getNames();
    window.roulette.setMarbles(names);
    ready = names.length > 0;
    localStorage.setItem('mbr_names', names.join(','));
    switch(winnerType){
        case 'first':
            setWinnerRank(1);
            break;
        case 'last':
            const total = window.roulette.getCount();
            setWinnerRank(total);
            break;
    }
}
function setWinnerRank(rank) {
    document.querySelector('#in_winningRank').value = rank;
    window.options.winningRank = rank - 1;
    window.roulette.setWinningRank(window.options.winningRank);
    if (winnerType === 'first') {
        document.querySelector('.btn-first-winner').classList.toggle('active', true);
        document.querySelector('.btn-last-winner').classList.toggle('active', false);
        document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'last') {
        document.querySelector('.btn-first-winner').classList.toggle('active', false);
        document.querySelector('.btn-last-winner').classList.toggle('active', true);
        document.querySelector('#in_winningRank').classList.toggle('active', false);
    } else if (winnerType === 'custom') {
        document.querySelector('.btn-first-winner').classList.toggle('active', false);
        document.querySelector('.btn-last-winner').classList.toggle('active', false);
        document.querySelector('#in_winningRank').classList.toggle('active', true);
    }
}
let ready = false;
let winnerType = 'first';
document.addEventListener('DOMContentLoaded', ()=>{
    initialize();
});
function initialize() {
    if (!window.roulette || !window.roulette.isReady) {
        console.log('does not loaded yet');
        setTimeout(initialize, 100);
        return;
    }
    console.log('initializing start');
    const urlParams = new URLSearchParams(window.location.search);
    const namesFromUrl = urlParams.get('names');
    if (namesFromUrl) document.querySelector('#in_names').value = namesFromUrl.replace(/,/g, '\n');
    else {
        const savedNames = localStorage.getItem('mbr_names');
        if (savedNames) document.querySelector('#in_names').value = savedNames;
    }
    document.querySelector('#in_names').addEventListener('input', ()=>{
        getReady();
    });
    document.querySelector('#in_names').addEventListener('blur', ()=>{
        const nameSource = getNames();
        const nameSet = new Set();
        const nameCounts = {};
        nameSource.forEach((nameSrc)=>{
            const name = parseName(nameSrc);
            const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
            if (!nameSet.has(key)) {
                nameSet.add(key);
                nameCounts[key] = 0;
            }
            nameCounts[key] += name.count;
        });
        const result = [];
        Object.keys(nameCounts).forEach((key)=>{
            if (nameCounts[key] > 1) result.push(`${key}*${nameCounts[key]}`);
            else result.push(key);
        });
        const oldValue = document.querySelector('#in_names').value;
        const newValue = result.join(',');
        if (oldValue !== newValue) {
            document.querySelector('#in_names').value = newValue;
            getReady();
        }
    });
    document.querySelector('#btnShuffle').addEventListener('click', ()=>{
        getReady();
    });
    document.querySelector('#btnStart').addEventListener('click', ()=>{
        if (!ready) return;
        gtag && gtag('event', 'start', {
            'event_category': 'roulette',
            'event_label': 'start',
            'value': window.roulette.getCount()
        });
        window.roulette.start();
        document.querySelector('#settings').classList.add('hide');
    });
    document.querySelector('#chkAutoRecording').addEventListener('change', (e)=>{
        window.options.autoRecording = e.target.matches(':checked');
        window.roulette.setAutoRecording(window.options.autoRecording);
    });
    document.querySelector('#chkSkill').addEventListener('change', (e)=>{
        window.options.useSkills = e.target.matches(':checked');
        window.roulette.setWinningRank(window.options.winningRank);
    });
    document.querySelector('#chkDarkMode').addEventListener('change', (e)=>{
        window.options.darkMode = e.target.matches(':checked');
        window.roulette.setTheme(window.options.darkMode ? 'dark' : 'light');
        document.documentElement.classList.toggle('light', !window.options.darkMode);
    });
    document.querySelector('#in_winningRank').addEventListener('change', (e)=>{
        const v = parseInt(e.target.value, 10);
        winnerType = 'custom';
        setWinnerRank(isNaN(v) ? 0 : v);
    });
    document.querySelector('.btn-last-winner').addEventListener('click', ()=>{
        const total = window.roulette.getCount();
        winnerType = 'last';
        setWinnerRank(total);
    });
    document.querySelector('.btn-first-winner').addEventListener('click', ()=>{
        winnerType = 'first';
        setWinnerRank(1);
    });
    window.roulette.addEventListener('goal', ()=>{
        ready = false;
        setTimeout(()=>{
            document.querySelector('#settings').classList.remove('hide');
        }, 3000);
    });
    window.roulette.addEventListener('message', (e)=>{
        simpleToast(e.detail);
    });
    document.querySelector('#btnShuffle').click();
    const maps = window.roulette.getMaps();
    const mapSelector = document.querySelector('#sltMap');
    maps.forEach((map)=>{
        const option = document.createElement('option');
        option.value = map.index;
        option.innerHTML = map.title;
        option.setAttribute('data-trans', '');
        window.translateElement(option);
        mapSelector.append(option);
    });
    mapSelector.addEventListener('change', (e)=>{
        const index = e.target.value;
        window.roulette.setMap(index);
    });
    // Game mode selector
    const gameModeSelector = document.querySelector('#sltGameMode');
    gameModeSelector.addEventListener('change', (e)=>{
        window.roulette.setGameMode(e.target.value);
    });
    function simpleToast(msg) {
        const toast = document.createElement('div');
        toast.classList.add('toast');
        toast.innerHTML = msg;
        if (window.translateElement) {
            console.log('try to translate');
            window.translateElement(toast);
        }
        document.body.appendChild(toast);
        setTimeout(()=>{
            document.body.removeChild(toast);
        }, 1200);
    }
}

</script>
<div id="settings" class="settings">
  <div class="right">
    <div class="row">
      <label for="sltMap">
        <i class="icon map"></i>
        <span data-trans="">Map</span>
      </label>
      <select id="sltMap"></select>
    </div>
    <div class="row">
      <label for="sltGameMode">
        <i class="icon trophy"></i>
        <span data-trans="">Game Mode</span>
      </label>
      <select id="sltGameMode">
        <option value="individual" data-trans="">Individual</option>
        <option value="team" data-trans="">Team</option>
      </select>
    </div>
    <div class="row">
      <label for="chkAutoRecording">
        <i class="icon record"></i>
        <span data-trans="">Recording</span>
      </label>
      <input type="checkbox" id="chkAutoRecording">
    </div>
    <div class="row">
      <label>
        <i class="icon trophy"></i>
        <span data-trans="">The winner is</span>
      </label>
      <div class="btn-group">
        <button class="btn-winner btn-first-winner active" data-trans="">First</button>
        <button class="btn-winner btn-last-winner" data-trans="">Last</button>
        <input type="number" id="in_winningRank" value="1" min="1">
      </div>
    </div>
    <div class="row">
      <label for="chkSkill">
        <i class="icon bomb"></i>
        <span data-trans="">Using skills</span>
      </label>
      <input type="checkbox" id="chkSkill" checked="">
      <div class="theme">
        <i class="icon sun"></i>
        <input type="checkbox" id="chkDarkMode" checked="">
        <i class="icon moon"></i>
      </div>
    </div>
  </div>
  <div class="left">
    <h3 data-trans="">Enter names below</h3>
    <textarea id="in_names" placeholder="Input names separated by commas or line feed here" data-trans="placeholder">짱구*5, 짱아*10, 봉미선*3</textarea>
    <div class="actions">
      <div class="sep"></div>
      <button id="btnShuffle">
        <i class="icon shuffle"></i>
        <span data-trans="">Shuffle</span>
      </button>
      <button id="btnStart">
        <i class="icon play"></i>
        <span data-trans="">Start</span>
      </button>
    </div>
  </div>
</div>


</body></html>